// Scraper.js - Injected into MMT or Agoda Page
// Supports: MakeMyTrip, Agoda
// Updated: Robust Agoda Support (Hash Dates + Regex Price)

(function () {
    const HOST = window.location.hostname;
    console.log("[Extension] Scraper Injected on:", HOST);

    // 1. ADD VISUAL BANNER
    const banner = document.createElement("div");
    banner.style.position = "fixed";
    banner.style.top = "0";
    banner.style.left = "0";
    banner.style.width = "100%";
    banner.style.backgroundColor = "red";
    banner.style.color = "white";
    banner.style.zIndex = "2147483647"; // Max Z-Index
    banner.style.textAlign = "center";
    banner.style.padding = "15px";
    banner.style.fontSize = "18px";
    banner.style.fontWeight = "bold";
    banner.style.fontFamily = "monospace";
    banner.innerText = `HOTELIER HUB: Loading... (${HOST})`;
    document.body.prepend(banner);

    function getElementByXpath(path) {
        return document.evaluate(path, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue;
    }

    // =========================================================================
    // HELPER: DATE PARSER (CRITICAL FOR AGODA)
    // =========================================================================
    function getCheckinDateFromUrl() {
        // 1. Try Query Params (Standard)
        const urlParams = new URLSearchParams(window.location.search);
        let checkin = urlParams.get('checkin') || urlParams.get('checkIn') || urlParams.get('checkinDate');

        // 2. Try Hash Params (Agoda often uses #checkIn=...)
        // e.g., #checkIn=2026-02-02
        if (!checkin && window.location.hash) {
            // Hash might act like query string
            try {
                const hashStr = window.location.hash.substring(1); // Remove #
                const hashParams = new URLSearchParams(hashStr);
                checkin = hashParams.get('checkin') || hashParams.get('checkIn');
            } catch (e) { console.warn("Hash Parse Fail", e); }
        }

        if (!checkin) {
            console.log("[Extension] No Checkin Found. Defaulting to Today.");
            return new Date().toISOString().split('T')[0];
        }

        // Normalize MMT 02022026 to 2026-02-02
        if (checkin.length === 8 && !checkin.includes('-')) {
            const m = checkin.substring(0, 2);
            const d = checkin.substring(2, 4);
            const y = checkin.substring(4, 8);
            return `${y}-${m}-${d}`;
        }

        return checkin;
    }

    // =========================================================================
    // STRATEGY: MAKEMYTRIP
    // =========================================================================
    function scrapeMMT() {
        let price = 0;
        let roomName = "Standard Room";
        let isSoldOut = false;

        // 1. Sold Out Check
        const soldOutSelectors = [
            ".htlSoldOutNew.soldOut", ".soldOutTxt",
            "//h4[contains(text(),'You Just Missed It')]",
            "//div[contains(@class,'hdrContainer__right--soldOut')]", ".soldOut"
        ];
        for (let sel of soldOutSelectors) {
            try {
                let el = sel.startsWith("//") ? getElementByXpath(sel) : document.querySelector(sel);
                if (el && el.offsetParent !== null) {
                    isSoldOut = true;
                    roomName = "Sold Out";
                    break;
                }
            } catch (e) { }
        }

        if (!isSoldOut && document.body.innerText.includes("You Just Missed It")) {
            isSoldOut = true;
            roomName = "Sold Out";
        }

        if (isSoldOut) return { is_sold_out: true, price: 0, room_type: "Sold Out" };

        // 2. Price Check
        const priceSelectors = [
            "#hlistpg_hotel_shown_price", "[id^='hlistpg_hotel_shown_price']",
            ".latoBlack.font28", ".font22.latoBlack",
            "p[id*='hlistpg_hotel_shown_price']",
            "//div[contains(@class,'priceDetails')]//p[contains(@class,'latoBlack')]"
        ];

        let priceText = null;
        for (let sel of priceSelectors) {
            try {
                let el = sel.startsWith("//") ? getElementByXpath(sel) : document.querySelector(sel);
                if (el && el.innerText) {
                    priceText = el.innerText;
                    break;
                }
            } catch (e) { }
        }

        if (priceText) price = parseFloat(priceText.replace(/[^\d.]/g, ''));
        if (isNaN(price)) price = 0;

        // 3. Room Name
        const roomEl = document.querySelector(".bkngOption__title");
        if (roomEl) roomName = roomEl.innerText;

        return { is_sold_out: false, price: price, room_type: roomName };
    }

    // =========================================================================
    // STRATEGY: AGODA
    // =========================================================================
    function scrapeAgoda() {
        let price = 0;
        let roomName = "Agoda Room";
        let isSoldOut = false;

        // 1. Sold Out Check
        if (document.body.innerText.includes("We're sorry, but there are no rooms available")) {
            isSoldOut = true;
        }

        if (isSoldOut) return { is_sold_out: true, price: 0, room_type: "Sold Out" };

        // 2. Price Check
        const priceSelectors = [
            "[data-selenium='display-price']",
            ".CrossTrack-Price",
            "[data-element-name='final-price']",
            ".pd-price",
            ".PriceContainer",
            "//span[@data-selenium='display-price']", // Best Bet
            "//div[@id='property-room-grid']//span[contains(@class,'PriceContainer')]",
            "//span[contains(@class,'PriceContainer-value')]"
        ];

        let priceText = null;
        for (let sel of priceSelectors) {
            try {
                let el = sel.startsWith("//") ? getElementByXpath(sel) : document.querySelector(sel);
                if (el && el.innerText) {
                    priceText = el.innerText;
                    console.log(`[Agoda] Found Price via Selector: ${sel}`);
                    break;
                }
            } catch (e) { }
        }

        // AGODA FALLBACK: Regex Search
        if (!priceText) {
            const agodaBody = document.body.innerText;
            // Look for ₹ 1,234 pattern strictly
            const match = agodaBody.match(/₹\s?([\d,]+)/);
            if (match) {
                priceText = match[1];
                console.log("[Agoda] Found Price via Regex Fallback");
            }
        }

        if (priceText) price = parseFloat(priceText.replace(/[^\d.]/g, ''));
        if (isNaN(price)) price = 0;

        return { is_sold_out: false, price: price, room_type: roomName };
    }


    // =========================================================================
    // MAIN LOOP
    // =========================================================================
    console.log("[Extension] Waiting 5s for Page Load...");
    setTimeout(() => {
        let attempts = 0;
        const maxAttempts = 8; // Extended to 8s

        const interval = setInterval(() => {
            attempts++;

            let data = { price: 0, is_sold_out: false, room_type: 'Unknown' };
            if (HOST.includes("makemytrip")) {
                data = scrapeMMT();
            } else if (HOST.includes("agoda")) {
                data = scrapeAgoda();
            }

            // Common Data Enriched
            data.check_in_date = getCheckinDateFromUrl();

            // VISUAL DEBUGGING
            banner.innerText = `[${HOST}] Date:${data.check_in_date} | Price:${data.price} | SoldOut:${data.is_sold_out} (${attempts}/${maxAttempts})`;
            console.log("[Extension] Scan:", data);

            if (data.price > 0 || data.is_sold_out) {
                clearInterval(interval);
                banner.style.backgroundColor = "green";
                banner.innerText = `SUCCESS! Found: ${data.price} (${data.check_in_date})`;
                setTimeout(() => {
                    chrome.runtime.sendMessage({ action: "SCRAPE_RESULT", data: [data] });
                }, 1000);
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                banner.style.backgroundColor = "orange";
                banner.innerText = `TIMEOUT (${data.check_in_date}) -> Defaulting to Sold Out`;
                data.is_sold_out = true;
                setTimeout(() => {
                    chrome.runtime.sendMessage({ action: "SCRAPE_RESULT", data: [data] });
                }, 1000);
            }
        }, 1000);
    }, 5000);

})();
